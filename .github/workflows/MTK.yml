name: Build GKI 5.10 LTS Kernel (RedmiNote13-zako~kernel+SUKISU+Opt-NoDT)
on: [workflow_dispatch]

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. 安装依赖
        run: |
          sudo apt update -y && sudo apt install -y --no-install-recommends git make bison flex gcc-aarch64-linux-gnu bc libssl-dev libelf-dev python3 curl liblz4-tool zstd clang lld llvm libncurses5-dev patch
          sudo apt clean && rm -rf /var/lib/apt/lists/*

      - name: 2. 拉5.10 LTS源码
        run: |
          git clone -b android12-5.10-lts --depth=1 https://android.googlesource.com/kernel/common GKI5.10
          cd GKI5.10 && git submodule update --init --depth=1
          echo "KERNEL_DIR=$(pwd)" >> $GITHUB_ENV

      - name: 3. 缓存Clang
        id: cache-clang
        uses: actions/cache@v3
        with:
          path: ./GKI5.10/clang-r547379
          key: clang-r547379-gki510-lts-rn13-nodt

      - name: 4. 下Clang（缓存未命中）
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          cd ${{ env.KERNEL_DIR }}
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz -O clang.tar.gz
          mkdir -p clang-r547379 && tar zxf clang.tar.gz -C clang-r547379 --skip-old-files && rm -f clang.tar.gz
          echo "CLANG_DIR=$(pwd)/clang-r547379" >> $GITHUB_ENV

      - name: 5. 集成SukiSU
        run: |
          cd ${{ env.KERNEL_DIR }}
          curl -LSs https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh | bash -s main
          [ -d KernelSU ] && echo SUKISU集成成功 || exit 1

      - name: 6. SukiSU C99兼容
        run: |
          cd ${{ env.KERNEL_DIR }}
          echo 'EXTRA_CFLAGS += -std=c99 -Wno-gcc-compat -Wno-unused-command-line-argument' >> drivers/kernelsu/kpm/Makefile
          echo 'EXTRA_CFLAGS += -Wno-type-limits -Wno-pointer-arith' >> drivers/kernelsu/Makefile
          sed -i '/KBUILD_CFLAGS += -std=gnu99/d' Makefile 2>/dev/null

      - name: 7. 修改内核名
        run: sed -i "s/LOCALVERSION=.*/LOCALVERSION=-RedmiNote13-nodt-zako~kernel-opt/" "${{ env.KERNEL_DIR }}/Makefile"

      - name: 8. 5.10内核专属优化补丁（充电+调度）
        run: |
          cd "${{ env.KERNEL_DIR }}"
          # 充电补丁（MT6833，适配5.10内核）
          cat > rn13_charge_opt.patch << EOF
          diff --git a/drivers/power/supply/mediatek/mt6833_charger.c b/drivers/power/supply/mediatek/mt6833_charger.c
          --- a/drivers/power/supply/mediatek/mt6833_charger.c
          +++ b/drivers/power/supply/mediatek/mt6833_charger.c
          @@ -200,7 +200,7 @@ static const struct mt6833_chg_cfg rn13_chg_cfg = {
              .max_input_current = 3000,
              .max_charge_current = 4000,
              .pre_charge_current = 500,
              .trickle_charge_current = 200,
          -    .fast_charge_voltage = 4350,
          +    .fast_charge_voltage = 4380,
              .temp_high_threshold = 45,
              .temp_critical_threshold = 55,
           };
          EOF

          # 调度补丁（天玑7020，适配5.10内核）
          cat > rn13_sched_opt.patch << EOF
          diff --git a/kernel/sched/cpufreq_interactive.c b/kernel/sched/cpufreq_interactive.c
          --- a/kernel/sched/cpufreq_interactive.c
          +++ b/kernel/sched/cpufreq_interactive.c
          @@ -350,8 +350,8 @@ static struct cpufreq_governor interactive_gov = {
          -    .min_sample_time = 50000,
          +    .min_sample_time = 20000,
          -    .above_hispeed_delay = 20000,
          +    .above_hispeed_delay = 10000,
           };
          diff --git a/kernel/sched/sched.h b/kernel/sched/sched.h
          --- a/kernel/sched/sched.h
          +++ b/kernel/sched/sched.h
          @@ -600,7 +600,7 @@ enum sched_tunable_scaling {
          -#define SCHED_BALANCE_BIG_LITTLE 15
          +#define SCHED_BALANCE_BIG_LITTLE 8
          EOF

          # 5.10内核补丁适配（无无效参数）
          [ -f drivers/power/supply/mediatek/mt6833_charger.c ] && git apply --ignore-space-change --recount rn13_charge_opt.patch || echo 充电补丁跳过
          [ -f kernel/sched/cpufreq_interactive.c ] && git apply --ignore-space-change --recount rn13_sched_opt.patch || echo 调度补丁跳过

      - name: 9. 5.10内核配置（GKI+SU+硬件适配）
        run: |
          cd "${{ env.KERNEL_DIR }}"
          cat > rn13_sukisu_temp.config << EOF
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KSU=y
          CONFIG_KPM=y
          CONFIG_MODULES=y
          CONFIG_MODULE_UNLOAD=y
          CONFIG_DEBUG_INFO_BTF=y
          CONFIG_MTK_CHARGER_MT6833=y
          CONFIG_MTK_BATTERY_MT6833=y
          CONFIG_CPU_FREQ_GOV_INTERACTIVE=y
          CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
          CONFIG_SCHED_BOOST=y
          CONFIG_SCHED_TUNE=y
          CONFIG_ARM64_CPU_BIG_LITTLE=y
          CONFIG_MTK_PMIC_MT6359=y
          EOF

          mkdir -p out
          make O=out ARCH=arm64 gki_defconfig
          cat rn13_sukisu_temp.config >> out/.config
          yes "" | make O=out ARCH=arm64 olddefconfig
          grep -E "CONFIG_KSU=y|CONFIG_MTK_CHARGER_MT6833=y" out/.config || { echo 配置失效; exit 1; }

      - name: 10. 编译5.10内核（仅Image，不编设备树）
        run: |
          cd "${{ env.KERNEL_DIR }}"
          export ARCH=arm64 SUBARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-
          export CC="${CLANG_DIR}/bin/clang" CLANG_TRIPLE=aarch64-linux-gnu-
          export LD="${CLANG_DIR}/bin/ld.lld" AR="${CLANG_DIR}/bin/llvm-ar" NM="${CLANG_DIR}/bin/llvm-nm"
          export OBJCOPY="${CLANG_DIR}/bin/objcopy" OBJDUMP="${CLANG_DIR}/bin/objdump"
          export KBUILD_CFLAGS="-Wno-error=unknown-warning-option -Wno-error=typeof -O2 -mtune=cortex-a55 -mcpu=cortex-a76"
          export KBUILD_LTO=none MAKEFLAGS="-j$(nproc)"

          make -j$(nproc) O=out ARCH=arm64 Image > build.log 2>&1 || { cat build.log; exit 1; }
          mkdir -p boot && cp out/arch/arm64/boot/Image boot/ && ls -l boot/

      - name: 11. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: RedmiNote13-GKI5.10-LTS-SukiSU-Opt-NoDT
          path: ${{ env.KERNEL_DIR }}/boot/*
          retention-days: 14
