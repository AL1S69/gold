name: Build GKI 5.10 LTS Kernel (zako~kernel+SUKISU)

on:
  workflow_dispatch:

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. 安装编译依赖
        run: |
          sudo apt-get update -y && sudo apt-get install -y --no-install-recommends \
            git make bison flex gcc-aarch64-linux-gnu bc libssl-dev libelf-dev \
            python3 curl liblz4-tool zstd clang lld llvm libncurses5-dev
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*

      - name: 2. 克隆官方GKI 5.10 LTS源码
        run: |
          git clone -b android12-5.10-lts --depth=1 https://android.googlesource.com/kernel/common GKI5.10
          cd GKI5.10
          git submodule update --init --depth=1
          echo "KERNEL_DIR=$(pwd)" >> $GITHUB_ENV

      - name: 3. 缓存Clang工具链
        id: cache-clang
        uses: actions/cache@v3
        with:
          path: ./GKI5.10/clang-r547379
          key: clang-r547379-gki510-lts

      - name: 4. 下载Clang（缓存未命中）
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          cd ${{ env.KERNEL_DIR }}
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz -O clang.tar.gz
          mkdir -p clang-r547379 && tar zxf clang.tar.gz -C clang-r547379 --skip-old-files
          rm -f clang.tar.gz
          echo "CLANG_DIR=$(pwd)/clang-r547379" >> $GITHUB_ENV

      - name: 5. 集成SukiSU-Ultra（main分支）
        run: |
          cd ${{ env.KERNEL_DIR }}
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
          [ -d "KernelSU" ] && echo "SUKISU集成成功" || exit 1

      - name: 6. 仅为SUKISU模块启用C99（核心修复，不影响内核全局）
        run: |
          cd ${{ env.KERNEL_DIR }}
          # 为KPM模块Makefile添加C99编译标志
          echo 'EXTRA_CFLAGS += -std=c99 -Wno-gcc-compat -Wno-unused-command-line-argument' >> drivers/kernelsu/kpm/Makefile
          # 为SUKISU主模块添加兼容标志
          echo 'EXTRA_CFLAGS += -Wno-type-limits -Wno-pointer-arith' >> drivers/kernelsu/Makefile
          # 移除全局C99配置（避免内核宏冲突）
          sed -i '/KBUILD_CFLAGS += -std=gnu99/d' Makefile 2>/dev/null

      - name: 7. 修改内核名（-zako~kernel）
        run: |
          sed -i "s/LOCALVERSION=.*/LOCALVERSION=-zako~kernel/" ${{ env.KERNEL_DIR }}/Makefile

      - name: 8. 配置GKI+SUKISU（移除全局C99配置项）
        run: |
          cd ${{ env.KERNEL_DIR }}
          # 分步创建临时配置文件（删除CONFIG_CC_STD_C99=y）
          echo "CONFIG_KALLSYMS=y" > sukisu_temp.config
          echo "CONFIG_KALLSYMS_ALL=y" >> sukisu_temp.config
          echo "CONFIG_KPROBES=y" >> sukisu_temp.config
          echo "CONFIG_HAVE_KPROBES=y" >> sukisu_temp.config
          echo "CONFIG_KPROBE_EVENTS=y" >> sukisu_temp.config
          echo "CONFIG_KSU=y" >> sukisu_temp.config
          echo "CONFIG_KPM=y" >> sukisu_temp.config
          echo "CONFIG_MODULES=y" >> sukisu_temp.config
          echo "CONFIG_MODULE_UNLOAD=y" >> sukisu_temp.config
          echo "CONFIG_DEBUG_INFO_BTF=y" >> sukisu_temp.config
          
          # 先创建out目录
          mkdir -p out
          # 加载基础配置
          make O=out ARCH=arm64 gki_defconfig
          # 追加并固化SUKISU配置
          cat sukisu_temp.config >> out/.config
          yes "" | make O=out ARCH=arm64 olddefconfig
          # 验证配置
          grep -E "CONFIG_KSU=y|CONFIG_KPM=y" ${{ env.KERNEL_DIR }}/out/.config || (echo "SUKISU配置失效" && exit 1)

      - name: 9. 全核心编译GKI内核+DTB（添加Clang兼容参数）
        run: |
          cd ${{ env.KERNEL_DIR }}
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CC=${{ env.CLANG_DIR }}/bin/clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export LD=${{ env.CLANG_DIR }}/bin/ld.lld
          export AR=${{ env.CLANG_DIR }}/bin/llvm-ar
          export NM=${{ env.CLANG_DIR }}/bin/llvm-nm
          export OBJCOPY=${{ env.CLANG_DIR }}/bin/objcopy
          export OBJDUMP=${{ env.CLANG_DIR }}/bin/objdump
          
          # 添加Clang兼容编译参数，解决typeof关键字问题
          export KBUILD_CFLAGS="-Wno-error=unknown-warning-option -Wno-error=typeof"
          export KBUILD_LTO=none
          export MAKEFLAGS="-j$(nproc)"
          
          make -j$(nproc) O=out ARCH=arm64 Image dtbs > build.log 2>&1 || (cat build.log && exit 1)
          
          mkdir -p ${{ env.KERNEL_DIR }}/boot
          cp -r out/arch/arm64/boot/* ${{ env.KERNEL_DIR }}/boot/
          ls -l ${{ env.KERNEL_DIR }}/boot/

      - name: 10. 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: zako~kernel-gki510-lts-sukisu
          path: ${{ env.KERNEL_DIR }}/boot/**/*
          retention-days: 14
